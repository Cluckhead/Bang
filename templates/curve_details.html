{# templates/curve_details.html #}
{% extends "base.html" %}

{% block title %}Yield Curve Details - {{ currency }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Yield Curve Details: <strong>{{ currency }}</strong></h1>
        <a href="{{ url_for('curve_bp.curve_summary') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to Summary
        </a>
    </div>

    {# Date and History Selection Row #}
    <div class="row mb-3 align-items-end">
        <div class="col-md-4">
            <label for="dateSelector" class="form-label">Select Date:</label>
            <select id="dateSelector" class="form-select">
                {% if available_dates %}
                    {% for date_str in available_dates %}
                        <option value="{{ date_str }}" {% if date_str == selected_date %}selected{% endif %}>
                            {{ date_str }}
                        </option>
                    {% endfor %}
                {% else %}
                    <option value="">No dates available</option>
                {% endif %}
            </select>
        </div>
        <div class="col-md-4">
            <label for="prevDaysSelector" class="form-label">Show Previous Days:</label>
            <select id="prevDaysSelector" class="form-select">
                {# Options for how many previous curves to show #}
                <option value="0" {% if num_prev_days == 0 %}selected{% endif %}>0 (None)</option>
                <option value="1" {% if num_prev_days == 1 %}selected{% endif %}>1</option>
                <option value="3" {% if num_prev_days == 3 %}selected{% endif %}>3</option>
                <option value="5" {% if num_prev_days == 5 %}selected{% endif %}>5</option>
            </select>
        </div>
    </div>

    {# Chart Card #}
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            Yield Curve for {{ selected_date }}{% if num_prev_days > 0 %} (with {{ num_prev_days }} previous day(s)){% endif %}
        </div>
        <div class="card-body">
            {% if chart_data and chart_data.labels and chart_data.datasets %}
                <canvas id="yieldCurveChart" style="height: 750px; width: 100%;"></canvas>
            {% else %}
                <div class="alert alert-warning" role="alert">
                    No data available to display the chart for {{ currency }} on {{ selected_date }}.
                </div>
            {% endif %}
        </div>
    </div>

    {# Data Table Card for Selected Date #}
    {% if table_data %}
    <div class="card shadow-sm">
        <div class="card-header">
            Data for {{ selected_date }} (Compared to Previous Day)
        </div>
        <div class="card-body">
             <div class="table-responsive">
                <table class="table table-sm table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Term</th>
                            <th>Term (Months, Approx)</th>
                            <th>Value</th>
                            <th>Daily Change</th>
                            <th>Deviation from Avg Shift</th>
                            <th>Deviation Z-Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in table_data %}
                            {# Apply conditional highlighting based on Z-score #}
                            {% set z_score = row.DeviationZScore | default(0, true) %}
                            {% set abs_z_score = z_score | abs %}
                            {% set row_class = '' %}
                            {% if abs_z_score > 3 %}
                                {% set row_class = 'table-danger' %}
                            {% elif abs_z_score > 2 %}
                                {% set row_class = 'table-warning' %}
                            {% endif %}
                            <tr class="{{ row_class }}">
                                <td>{{ row.Term }}</td>
                                <td>{{ row.TermMonths }}</td>
                                <td>{{ row.Value_Display | round(4) }}</td>
                                {# Format new columns, handle NaN with default filter #}
                                <td>{{ row.ValueChange | default('N/A', true) | round(4) }}</td>
                                <td>{{ row.ChangeDeviation | default('N/A', true) | round(4) }}</td>
                                <td>{{ z_score | default('N/A', true) | round(2) }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <small class="text-muted">Highlighting: Yellow if |Z-Score| > 2, Red if |Z-Score| > 3. Z-Score measures how many standard deviations a term's daily change deviated from the average daily change of the whole curve.</small>
            </div>
        </div>
    </div>
    {% endif %}

</div> {# End container #}
{% endblock %}

{% block scripts %}
{{ super() }} {# Include scripts from base.html #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script> {# Include Chart.js #}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chartData = {{ chart_data | tojson | safe }};
    const ctx = document.getElementById('yieldCurveChart');
    let yieldChart = null; // Reference to the chart instance

    function renderChart() {
        if (yieldChart) {
            yieldChart.destroy(); // Destroy previous chart instance if exists
        }
        if (ctx && chartData && chartData.labels && chartData.labels.length > 0 && chartData.datasets && chartData.datasets.length > 0) {
            console.log("Rendering chart with data:", chartData);
            yieldChart = new Chart(ctx, {
                type: 'line',
                data: chartData, // Now contains multiple datasets
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Term (Months)' // Already updated
                            },
                            type: 'linear',
                            position: 'bottom'
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Yield Value'
                            },
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        },
                        title: {
                             display: true,
                             // Base title on the first dataset (selected date)
                             text: chartData.datasets[0].label ?
                                   `Yield Curves - ${chartData.datasets[0].label.split('(')[0].trim()}` :
                                   'Yield Curve'
                        },
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        } else {
             console.log("Chart canvas not found or no chart data available.");
        }
    }

    renderChart(); // Initial rendering

    // Update URL and reload page when selectors change
    const dateSelector = document.getElementById('dateSelector');
    const prevDaysSelector = document.getElementById('prevDaysSelector');

    function updateUrlAndReload() {
        const selectedDate = dateSelector.value;
        const selectedPrevDays = prevDaysSelector.value;
        if (selectedDate) {
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('date', selectedDate);
            currentUrl.searchParams.set('prev_days', selectedPrevDays);
            window.location.href = currentUrl.toString();
        }
    }

    if (dateSelector) {
        dateSelector.addEventListener('change', updateUrlAndReload);
    }
    if (prevDaysSelector) {
        prevDaysSelector.addEventListener('change', updateUrlAndReload);
    }
});
</script>
{% endblock %} 