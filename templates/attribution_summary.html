{#
    Purpose: Attribution summary page. Shows two tables of residuals by fund and date for:
    - Benchmark (Prod, S&P)
    - Portfolio (Prod, S&P)
#}

{% extends "base.html" %}

{% block title %}Attribution Residuals Summary{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h1>Attribution Residuals Summary</h1>
    <p class="text-muted">Sum of residuals by fund and date. Residual = L0 Total - (L1 Rates + L1 Credit + L1 FX). Perfect attribution: residual = 0.</p>

    <!-- Level Toggle -->
    <form method="get" class="mb-3" id="level-toggle-form">
        <input type="hidden" name="fund" value="{{ selected_fund }}">
        <input type="hidden" name="characteristic" value="{{ selected_characteristic }}">
        <input type="hidden" name="start_date" value="{{ start_date.strftime('%Y-%m-%d') }}">
        <input type="hidden" name="end_date" value="{{ end_date.strftime('%Y-%m-%d') }}">
        <div class="btn-group" role="group" aria-label="Level toggle">
            <input type="radio" class="btn-check" name="level" id="level-l0" value="L0" autocomplete="off" {% if selected_level == 'L0' %}checked{% endif %} onchange="this.form.submit()">
            <label class="btn btn-outline-primary" for="level-l0">L0</label>
            <input type="radio" class="btn-check" name="level" id="level-l1" value="L1" autocomplete="off" {% if selected_level == 'L1' %}checked{% endif %} onchange="this.form.submit()">
            <label class="btn btn-outline-primary" for="level-l1">L1</label>
            <input type="radio" class="btn-check" name="level" id="level-l2" value="L2" autocomplete="off" {% if selected_level == 'L2' %}checked{% endif %} onchange="this.form.submit()">
            <label class="btn btn-outline-primary" for="level-l2">L2</label>
        </div>
    </form>

    <!-- Filter Form -->
    <form method="get" class="row g-3 align-items-end mb-4" id="filter-form">
        <div class="col-md-3">
            <label for="fund-select" class="form-label">Fund</label>
            <select class="form-select" id="fund-select" name="fund" onchange="this.form.submit()">
                <option value="" {% if not selected_fund %}selected{% endif %}>All Funds</option>
                {% for fund in available_funds %}
                    <option value="{{ fund }}" {% if fund == selected_fund %}selected{% endif %}>{{ fund }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="characteristic-select" class="form-label">Group by Characteristic</label>
            <select class="form-select" id="characteristic-select" name="characteristic" onchange="this.form.submit()">
                {% for char in available_characteristics %}
                    <option value="{{ char }}" {% if char == selected_characteristic %}selected{% endif %}>{{ char }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6">
            <label for="date-range-slider" class="form-label">Date Range</label>
            <div>
                <input type="range" class="form-range" id="date-range-slider" min="0" max="{{ (max_date - min_date).days }}" value="0" step="1">
                <input type="range" class="form-range" id="date-range-slider-end" min="0" max="{{ (max_date - min_date).days }}" value="{{ (end_date - min_date).days }}" step="1">
                <div class="d-flex justify-content-between">
                    <span id="start-date-label">{{ start_date.strftime('%Y-%m-%d') }}</span>
                    <span id="end-date-label">{{ end_date.strftime('%Y-%m-%d') }}</span>
                </div>
                <input type="hidden" name="start_date" id="start-date-input" value="{{ start_date.strftime('%Y-%m-%d') }}">
                <input type="hidden" name="end_date" id="end-date-input" value="{{ end_date.strftime('%Y-%m-%d') }}">
                <input type="hidden" name="level" value="{{ selected_level }}">
            </div>
        </div>
        <div class="col-md-3">
            <button type="submit" class="btn btn-primary">Apply Filters</button>
        </div>
    </form>

    <div class="mb-3">
        <strong>Current Filters:</strong>
        <span>Fund: {{ selected_fund if selected_fund else 'All' }}</span> |
        <span>Date: {{ start_date.strftime('%Y-%m-%d') }} to {{ end_date.strftime('%Y-%m-%d') }}</span> |
        <span>Characteristic: {{ selected_characteristic }}</span> |
        <span>Level: {{ selected_level }}</span>
    </div>

    <div class="row">
        <div class="col-md-12">
            <h3>Benchmark</h3>
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-sm">
                    <thead>
                        <tr>
                            <th rowspan="2">Date</th>
                            <th rowspan="2">Fund</th>
                            {% if selected_characteristic %}<th rowspan="2">{{ selected_characteristic }}</th>{% endif %}
                            {% if selected_level == 'L0' or selected_level == None %}
                                <th colspan="2">Residual</th>
                                <th colspan="2">Abs Residual</th>
                            {% elif selected_level == 'L1' %}
                                <th colspan="2">L1 Rates</th>
                                <th colspan="2">L1 Credit</th>
                                <th colspan="2">L1 FX</th>
                            {% elif selected_level == 'L2' %}
                                <th colspan="2">Credit Spread Change</th>
                                <th colspan="2">Credit Convexity</th>
                                <th colspan="2">Credit Carry</th>
                                <th colspan="2">Credit Defaulted</th>
                                <th colspan="2">Rates Carry</th>
                                <th colspan="2">Rates Convexity</th>
                                <th colspan="2">Rates Curve</th>
                                <th colspan="2">Rates Duration</th>
                                <th colspan="2">Rates Roll</th>
                                <th colspan="2">FX Carry</th>
                                <th colspan="2">FX Change</th>
                            {% endif %}
                        </tr>
                        <tr>
                            {% if selected_level == 'L0' or selected_level == None %}
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                            {% elif selected_level == 'L1' %}
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                            {% elif selected_level == 'L2' %}
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in benchmark_results %}
                        <tr>
                            <td>{{ row.Date.strftime('%Y-%m-%d') if row.Date else '' }}</td>
                            <td>{{ row.Fund }}</td>
                            {% if selected_characteristic %}<td>{{ row[selected_characteristic] }}</td>{% endif %}
                            {% if selected_level == 'L0' or selected_level == None %}
                                <td>{{ '%.6f'|format(row.Residual_Prod) }}</td>
                                <td>{{ '%.6f'|format(row.Residual_SP) }}</td>
                                <td>{{ '%.6f'|format(row.AbsResidual_Prod) }}</td>
                                <td>{{ '%.6f'|format(row.AbsResidual_SP) }}</td>
                            {% elif selected_level == 'L1' %}
                                <td>{{ '%.6f'|format(row.L1Rates_Prod) }}</td>
                                <td>{{ '%.6f'|format(row.L1Rates_SP) }}</td>
                                <td>{{ '%.6f'|format(row.L1Credit_Prod) }}</td>
                                <td>{{ '%.6f'|format(row.L1Credit_SP) }}</td>
                                <td>{{ '%.6f'|format(row.L1FX_Prod) }}</td>
                                <td>{{ '%.6f'|format(row.L1FX_SP) }}</td>
                            {% elif selected_level == 'L2' %}
                                {% for key in row.L2ProdKeys %}
                                    <td>{{ '%.6f'|format(row.L2Prod[key]) }}</td>
                                    <td>{{ '%.6f'|format(row.L2SP[key]) }}</td>
                                {% endfor %}
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                    <!-- Totals row omitted for L1/L2 for simplicity -->
                    {% if selected_level == 'L0' or selected_level == None %}
                    <tfoot>
                        <tr class="table-secondary fw-bold">
                            <td colspan="{% if selected_characteristic %}3{% else %}2{% endif %}">Total</td>
                            <td>{{ '%.6f'|format(benchmark_results|sum(attribute='Residual_Prod')) }}</td>
                            <td>{{ '%.6f'|format(benchmark_results|sum(attribute='Residual_SP')) }}</td>
                            <td>{{ '%.6f'|format(benchmark_results|sum(attribute='AbsResidual_Prod')) }}</td>
                            <td>{{ '%.6f'|format(benchmark_results|sum(attribute='AbsResidual_SP')) }}</td>
                        </tr>
                    </tfoot>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-12">
            <h3>Portfolio</h3>
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-sm">
                    <thead>
                        <tr>
                            <th rowspan="2">Date</th>
                            <th rowspan="2">Fund</th>
                            {% if selected_characteristic %}<th rowspan="2">{{ selected_characteristic }}</th>{% endif %}
                            {% if selected_level == 'L0' or selected_level == None %}
                                <th colspan="2">Residual</th>
                                <th colspan="2">Abs Residual</th>
                            {% elif selected_level == 'L1' %}
                                <th colspan="2">L1 Rates</th>
                                <th colspan="2">L1 Credit</th>
                                <th colspan="2">L1 FX</th>
                            {% elif selected_level == 'L2' %}
                                <th colspan="2">Credit Spread Change</th>
                                <th colspan="2">Credit Convexity</th>
                                <th colspan="2">Credit Carry</th>
                                <th colspan="2">Credit Defaulted</th>
                                <th colspan="2">Rates Carry</th>
                                <th colspan="2">Rates Convexity</th>
                                <th colspan="2">Rates Curve</th>
                                <th colspan="2">Rates Duration</th>
                                <th colspan="2">Rates Roll</th>
                                <th colspan="2">FX Carry</th>
                                <th colspan="2">FX Change</th>
                            {% endif %}
                        </tr>
                        <tr>
                            {% if selected_level == 'L0' or selected_level == None %}
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                            {% elif selected_level == 'L1' %}
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                            {% elif selected_level == 'L2' %}
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                                <th>Prod</th><th>S&amp;P</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in portfolio_results %}
                        <tr>
                            <td>{{ row.Date.strftime('%Y-%m-%d') if row.Date else '' }}</td>
                            <td>{{ row.Fund }}</td>
                            {% if selected_characteristic %}<td>{{ row[selected_characteristic] }}</td>{% endif %}
                            {% if selected_level == 'L0' or selected_level == None %}
                                <td>{{ '%.6f'|format(row.Residual_Prod) }}</td>
                                <td>{{ '%.6f'|format(row.Residual_SP) }}</td>
                                <td>{{ '%.6f'|format(row.AbsResidual_Prod) }}</td>
                                <td>{{ '%.6f'|format(row.AbsResidual_SP) }}</td>
                            {% elif selected_level == 'L1' %}
                                <td>{{ '%.6f'|format(row.L1Rates_Prod) }}</td>
                                <td>{{ '%.6f'|format(row.L1Rates_SP) }}</td>
                                <td>{{ '%.6f'|format(row.L1Credit_Prod) }}</td>
                                <td>{{ '%.6f'|format(row.L1Credit_SP) }}</td>
                                <td>{{ '%.6f'|format(row.L1FX_Prod) }}</td>
                                <td>{{ '%.6f'|format(row.L1FX_SP) }}</td>
                            {% elif selected_level == 'L2' %}
                                {% for key in row.L2ProdKeys %}
                                    <td>{{ '%.6f'|format(row.L2Prod[key]) }}</td>
                                    <td>{{ '%.6f'|format(row.L2SP[key]) }}</td>
                                {% endfor %}
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                    {% if selected_level == 'L0' or selected_level == None %}
                    <tfoot>
                        <tr class="table-secondary fw-bold">
                            <td colspan="{% if selected_characteristic %}3{% else %}2{% endif %}">Total</td>
                            <td>{{ '%.6f'|format(portfolio_results|sum(attribute='Residual_Prod')) }}</td>
                            <td>{{ '%.6f'|format(portfolio_results|sum(attribute='Residual_SP')) }}</td>
                            <td>{{ '%.6f'|format(portfolio_results|sum(attribute='AbsResidual_Prod')) }}</td>
                            <td>{{ '%.6f'|format(portfolio_results|sum(attribute='AbsResidual_SP')) }}</td>
                        </tr>
                    </tfoot>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Date slider logic
(function() {
    const minDate = new Date("{{ min_date.strftime('%Y-%m-%d') }}");
    const maxDate = new Date("{{ max_date.strftime('%Y-%m-%d') }}");
    const startDateInput = document.getElementById('start-date-input');
    const endDateInput = document.getElementById('end-date-input');
    const startDateLabel = document.getElementById('start-date-label');
    const endDateLabel = document.getElementById('end-date-label');
    const sliderStart = document.getElementById('date-range-slider');
    const sliderEnd = document.getElementById('date-range-slider-end');

    function daysBetween(d1, d2) {
        return Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
    }
    function addDays(date, days) {
        const d = new Date(date);
        d.setDate(d.getDate() + days);
        return d;
    }
    function formatDate(date) {
        return date.toISOString().slice(0, 10);
    }

    function updateLabelsAndInputs() {
        let startDays = parseInt(sliderStart.value, 10);
        let endDays = parseInt(sliderEnd.value, 10);
        if (endDays < startDays) {
            // Swap if needed
            [startDays, endDays] = [endDays, startDays];
            sliderStart.value = startDays;
            sliderEnd.value = endDays;
        }
        const start = addDays(minDate, startDays);
        const end = addDays(minDate, endDays);
        startDateLabel.textContent = formatDate(start);
        endDateLabel.textContent = formatDate(end);
        startDateInput.value = formatDate(start);
        endDateInput.value = formatDate(end);
    }

    sliderStart.addEventListener('input', updateLabelsAndInputs);
    sliderEnd.addEventListener('input', updateLabelsAndInputs);

    // Set initial slider positions based on current filter
    sliderStart.value = daysBetween(minDate, new Date("{{ start_date.strftime('%Y-%m-%d') }}"));
    sliderEnd.value = daysBetween(minDate, new Date("{{ end_date.strftime('%Y-%m-%d') }}"));
    updateLabelsAndInputs();
})();
</script>
{% endblock %} 