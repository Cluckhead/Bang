{% extends 'base.html' %}

{% block title %}Manage Security Exclusions{% endblock %}

{% block content %}
<div class="container" style="width: 90%; max-width: 90vw; min-width: 900px;">
    <h2>Manage Security Exclusions</h2>
    <hr>

    {# Display messages if any #}
    {% if message %}
        <div class="alert alert-{{ message_type }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}

    <div class="row">
        {# Left Column: Display Current Exclusions #}
        <div class="col-md-7">
            <h4>Current Exclusions</h4>
            {% if exclusions %}
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Security ID</th>
                            <th>Is Distressed</th>
                            <th>Date Added</th>
                            <th>End Date</th>
                            <th>Comment</th>
                            <th>Added By</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for exclusion in exclusions %}
                            <tr>
                                <td>{{ exclusion.SecurityID }}</td>
                                <td>{{ exclusion['Is Distressed'] if 'Is Distressed' in exclusion else '' }}</td>
                                <td>{{ exclusion.AddDate.strftime('%Y-%m-%d') if exclusion.AddDate else 'N/A' }}</td>
                                <td>{{ exclusion.EndDate.strftime('%Y-%m-%d') if exclusion.EndDate else '' }}</td>
                                <td style="max-width: 350px; word-break: break-word;">{{ exclusion.Comment }}</td>
                                <td>{{ exclusion.User if exclusion.User is defined else '' }}</td>
                                <td>
                                    <form method="POST" action="{{ url_for('exclusion_bp.remove_exclusion_route') }}" style="display: inline;">
                                        <input type="hidden" name="security_id" value="{{ exclusion.SecurityID }}">
                                        <input type="hidden" name="add_date" value="{{ exclusion.AddDate.strftime('%Y-%m-%d') if exclusion.AddDate else '' }}">
                                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to remove this exclusion?');">Remove</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No securities are currently excluded.</p>
            {% endif %}
        </div>

        {# Right Column: Add New Exclusion Form #}
        <div class="col-md-5">
            <h4>Add New Exclusion</h4>
            <form method="POST" action="{{ url_for('exclusion_bp.manage_exclusions') }}">
                {# --- Filter dropdowns for CCY, Security Sub Type, Country Of Risk --- #}
                <div class="mb-3">
                    <div class="row g-2">
                        <div class="col">
                            <label for="filter-ccy" class="form-label">CCY</label>
                            <select id="filter-ccy" class="form-select form-select-sm">
                                <option value="">All</option>
                                {% set ccy_options = available_securities | map(attribute='CCY') | unique | list | sort %}
                                {% for ccy in ccy_options %}
                                    <option value="{{ ccy }}">{{ ccy }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col">
                            <label for="filter-subtype" class="form-label">Security Sub Type</label>
                            <select id="filter-subtype" class="form-select form-select-sm">
                                <option value="">All</option>
                                {% set subtype_options = available_securities | map(attribute='Security Sub Type') | unique | list | sort %}
                                {% for subtype in subtype_options %}
                                    <option value="{{ subtype }}">{{ subtype }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col">
                            <label for="filter-country" class="form-label">Country Of Risk</label>
                            <select id="filter-country" class="form-select form-select-sm">
                                <option value="">All</option>
                                {% set country_options = available_securities | map(attribute='Country Of Risk') | unique | list | sort %}
                                {% for country in country_options %}
                                    <option value="{{ country }}">{{ country }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                {# --- End filter dropdowns --- #}

                <div class="mb-3">
                    <label for="security-search-input" class="form-label">Search & Select Security:</label>
                    <input type="text" id="security-search-input" class="form-control mb-2" placeholder="Type to filter securities...">
                    <select class="form-select" id="security-select" name="security_id" required>
                        <option value="" disabled selected>Select a Security</option>
                        {# Show ISIN - Security Name in the dropdown, and add Is Distressed as a data attribute #}
                        {% for sec in available_securities %}
                            <option value="{{ sec.ISIN }}" data-ccy="{{ sec.CCY }}" data-subtype="{{ sec['Security Sub Type'] }}" data-country="{{ sec['Country Of Risk'] }}" data-distressed="{{ sec['Is Distressed'] if 'Is Distressed' in sec else '' }}">
                                {{ sec.ISIN }} - {{ sec['Security Name'] }}{% if sec['Is Distressed'] == 'TRUE' %} (Distressed){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="end_date" class="form-label">End Date (Optional):</label>
                    <input type="date" class="form-control" id="end_date" name="end_date">
                </div>
                <div class="mb-3">
                    <label for="user-select" class="form-label">Added By (User):</label>
                    <select class="form-select" id="user-select" name="user" required>
                        <option value="" disabled selected>Select User</option>
                        {% for user in users %}
                            <option value="{{ user }}">{{ user }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="comment" class="form-label">Comment (Required):</label>
                    <textarea class="form-control" id="comment" name="comment" rows="4" style="width: 98%; min-width: 400px; max-width: 99%;"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Add Exclusion</button>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// --- Client-side filtering for the security dropdown ---
// This script filters the main security dropdown based on the three filter dropdowns and the search box.
// It is designed to be fast and work for up to 10,000 options.

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('security-search-input');
    const select = document.getElementById('security-select');
    const filterCCY = document.getElementById('filter-ccy');
    const filterSubtype = document.getElementById('filter-subtype');
    const filterCountry = document.getElementById('filter-country');

    // Store all options in memory for fast filtering
    const allOptions = Array.from(select.options).filter(opt => opt.value !== ""); // Exclude placeholder

    // Helper: Apply all filters and search
    function applyFilters() {
        const search = searchInput.value.trim().toLowerCase();
        const ccy = filterCCY.value;
        const subtype = filterSubtype.value;
        const country = filterCountry.value;
        let firstVisible = null;

        // Hide all options initially
        allOptions.forEach(opt => {
            let show = true;
            // Filter by CCY
            if (ccy && opt.getAttribute('data-ccy') !== ccy) show = false;
            // Filter by Subtype
            if (subtype && opt.getAttribute('data-subtype') !== subtype) show = false;
            // Filter by Country
            if (country && opt.getAttribute('data-country') !== country) show = false;
            // Filter by search (ISIN or Name)
            if (show && search) {
                const text = opt.textContent.toLowerCase();
                if (!text.includes(search)) show = false;
            }
            opt.style.display = show ? '' : 'none';
            if (show && !firstVisible) firstVisible = opt;
        });
        // Optionally, select the first visible option if none is selected
        // (Do not auto-select to avoid accidental submissions)
    }

    // Event listeners for all filters
    searchInput.addEventListener('input', applyFilters);
    filterCCY.addEventListener('change', applyFilters);
    filterSubtype.addEventListener('change', applyFilters);
    filterCountry.addEventListener('change', applyFilters);

    // Optional: Reset search/filter when dropdown is focused
    select.addEventListener('focus', function() {
        // Uncomment to clear search on focus:
        // searchInput.value = '';
        // applyFilters();
    });

    // Initial filter (in case filters are pre-selected)
    applyFilters();
});
</script>
{% endblock %} 