{% extends "base.html" %}

{% block title %}Get Data via API{% endblock %}

{% block content %}
<div class="container mt-4">

    {# --- Display Data File Statuses --- #}
    <div class="card mb-4">
        <div class="card-header">
            Current Data File Status
        </div>
        <div class="card-body">
            <p class="card-text"><small class="text-muted">Data Folder: <code>{{ data_folder }}</code></small></p>
            {% if data_file_statuses %}
            <table class="table table-sm table-striped table-bordered">
                <thead>
                    <tr>
                        <th>File Name</th>
                        <th>Latest Data Date (in file)</th>
                        <th>File Last Modified</th>
                        <th>Funds Included</th>
                    </tr>
                </thead>
                <tbody>
                    {% for status in data_file_statuses %}
                    <tr>
                        <td>{{ status.filename }}</td>
                        <td>
                            {% if status.exists %}
                                {{ status.latest_data_date }}
                            {% else %}
                                <span class="text-muted">File Not Found</span>
                            {% endif %}
                        </td>
                        <td>
                             {% if status.exists %}
                                {{ status.last_modified }}
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                             {% if status.exists %}
                                {{ status.funds_included }}
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-muted">Could not retrieve data file statuses. Check QueryMap.csv or server logs.</p>
            {% endif %}
        </div>
    </div>
    {# --- End Display Data File Statuses --- #}

    <h2>Get Data via API</h2>
    <p>Select funds and date range to retrieve and process data using the API.</p>
    <p>The API calls and processing will be printed in the terminal where the Flask app is running.</p>

    <form id="get-data-form">
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="daysBack" class="form-label">Days Back:</label>
                <input type="number" class="form-control" id="daysBack" name="days_back" value="30" required>
                <div class="form-text">Number of days of history to retrieve ending on the End Date.</div>
            </div>
            <div class="col-md-4">
                <label for="endDate" class="form-label">End Date:</label>
                <input type="date" class="form-control" id="endDate" name="end_date" value="{{ default_end_date }}" required>
                <div class="form-text">Defaults to the previous business day.</div>
            </div>
            <div class="col-md-4">
                <label class="form-label">Date Range Mode:</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="date_mode" id="dateModeQuick" value="quick" checked>
                    <label class="form-check-label" for="dateModeQuick">Use Days Back & End Date</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="date_mode" id="dateModeRange" value="range">
                    <label class="form-check-label" for="dateModeRange">Use Custom Date Range</label>
                </div>
            </div>
        </div>
        <div class="row mb-3" id="custom-date-range-row" style="display: none;">
            <div class="col-md-4">
                <label for="startDate" class="form-label">Start Date:</label>
                <input type="date" class="form-control" id="startDate" name="start_date">
            </div>
            <div class="col-md-4">
                <label for="customEndDate" class="form-label">End Date:</label>
                <input type="date" class="form-control" id="customEndDate" name="custom_end_date">
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">Data Write Mode:</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="write_mode" id="writeModeExpand" value="expand" checked>
                <label class="form-check-label" for="writeModeExpand">Expand (append new data, overwrite overlaps)</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="write_mode" id="writeModeOverwrite" value="overwrite_all">
                <label class="form-check-label" for="writeModeOverwrite">Run and Overwrite All (start every file from scratch)</label>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">Select Funds:</label>
             <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="select-all-funds">Select All</button>
             <button type="button" class="btn btn-sm btn-outline-secondary ms-1" id="deselect-all-funds">Deselect All</button>
            <div id="fund-list" class="border p-3" style="max-height: 300px; overflow-y: auto;">
                {% for fund in funds %}
                <div class="form-check">
                    <input class="form-check-input fund-checkbox" type="checkbox" value="{{ fund['Fund Code'] }}" id="fund-{{ fund['Fund Code'] }}" name="funds"
                           {% if fund['Picked'] %}checked{% endif %}>
                    <label class="form-check-label" for="fund-{{ fund['Fund Code'] }}">
                        {{ fund['Fund Code'] }} (AUM: {{ fund['Total Asset Value USD']|int }})
                    </label>
                </div>
                {% else %}
                <p class="text-danger">No funds found or FundList.csv could not be loaded correctly.</p>
                {% endfor %}
            </div>
             <div class="form-text text-danger d-none" id="fund-selection-error">Please select at least one fund.</div>
        </div>

        <button type="submit" class="btn btn-primary">Run API Calls</button>
        <button type="button" id="run-overwrite-button" class="btn btn-warning ms-2">Run and Overwrite Data</button>
        <button type="button" id="run-cleanup-button" class="btn btn-secondary ms-2">Run Data Cleanup</button>
    </form>

    <div id="status-area" class="mt-4" style="display: none;">
        <h4>Processing Status</h4>
        <div class="progress mb-2" style="height: 20px;">
            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
        <p id="status-message"></p>
        <div id="results-summary" class="mt-3">
            <h5>Results Summary</h5>
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Query ID</th>
                        <th>File Name</th>
                        <th>Rows Returned</th>
                        <th>File Lines</th>
                        <th>Last Written</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="results-table-body">
                    <!-- Results will be populated here -->
                </tbody>
            </table>
        </div>
         <div id="error-message" class="alert alert-danger mt-3" style="display: none;">
             <!-- Errors shown here -->
         </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
{{ super() }} {# Include scripts from base.html #}
<script>
// .SYNOPSIS
//     JavaScript for Get Data via API page. Handles form logic, date range and write mode selection, API calls, and results table updates.
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('get-data-form');
    const statusArea = document.getElementById('status-area');
    const statusMessage = document.getElementById('status-message');
    const progressBar = document.getElementById('progress-bar');
    const resultsTableBody = document.getElementById('results-table-body');
    const errorMessageDiv = document.getElementById('error-message');
    const fundSelectionError = document.getElementById('fund-selection-error');
    const cleanupButton = document.getElementById('run-cleanup-button');
    const runOverwriteButton = document.getElementById('run-overwrite-button');
    const cleanupStatus = document.createElement('div');
    cleanupStatus.id = 'cleanup-status';
    cleanupStatus.className = 'mt-2';
    cleanupButton.parentNode.insertBefore(cleanupStatus, cleanupButton.nextSibling);
    const fundCheckboxes = document.querySelectorAll('.fund-checkbox');
    const selectAllButton = document.getElementById('select-all-funds');
    const deselectAllButton = document.getElementById('deselect-all-funds');
    const dateModeQuick = document.getElementById('dateModeQuick');
    const dateModeRange = document.getElementById('dateModeRange');
    const customDateRangeRow = document.getElementById('custom-date-range-row');
    const startDateInput = document.getElementById('startDate');
    const customEndDateInput = document.getElementById('customEndDate');
    const writeModeExpand = document.getElementById('writeModeExpand');
    const writeModeOverwrite = document.getElementById('writeModeOverwrite');

    // Show/hide custom date range row based on radio selection
    function updateDateRangeVisibility() {
        if (dateModeRange.checked) {
            customDateRangeRow.style.display = '';
        } else {
            customDateRangeRow.style.display = 'none';
        }
    }
    dateModeQuick.addEventListener('change', updateDateRangeVisibility);
    dateModeRange.addEventListener('change', updateDateRangeVisibility);
    updateDateRangeVisibility(); // Initial state

    // Select/Deselect All Funds buttons
    selectAllButton.addEventListener('click', () => {
        fundCheckboxes.forEach(checkbox => checkbox.checked = true);
    });
    deselectAllButton.addEventListener('click', () => {
        fundCheckboxes.forEach(checkbox => checkbox.checked = false);
    });

    // --- Function to handle the API call logic ---
    async function handleApiCall(forceOverwriteButton = false) {
        // Clear previous results and errors
        statusArea.style.display = 'none';
        resultsTableBody.innerHTML = '';
        errorMessageDiv.style.display = 'none';
        errorMessageDiv.textContent = '';
        cleanupButton.style.display = 'none';
        cleanupStatus.textContent = '';
        cleanupStatus.className = 'mt-2';
        statusMessage.textContent = '';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        progressBar.classList.remove('bg-success', 'bg-danger');
        fundSelectionError.classList.add('d-none');

        // Get selected funds
        const selectedFunds = Array.from(document.querySelectorAll('input[name="funds"]:checked'))
                                 .map(cb => cb.value);
        if (selectedFunds.length === 0) {
            fundSelectionError.classList.remove('d-none');
            return;
        }

        // Date mode and values
        const dateMode = dateModeRange.checked ? 'range' : 'quick';
        let startDate = null, customEndDate = null, daysBack = null, endDate = null;
        if (dateMode === 'range') {
            startDate = startDateInput.value;
            customEndDate = customEndDateInput.value;
            if (!startDate || !customEndDate) {
                errorMessageDiv.textContent = 'Please select both Start Date and End Date for the custom range.';
                errorMessageDiv.style.display = 'block';
                return;
            }
        } else {
            daysBack = document.getElementById('daysBack').value;
            endDate = document.getElementById('endDate').value;
            if (!endDate) {
                errorMessageDiv.textContent = 'Please select an End Date.';
                errorMessageDiv.style.display = 'block';
                return;
            }
        }

        // Write mode
        const writeMode = writeModeOverwrite.checked ? 'overwrite_all' : 'expand';

        // Show status area and indicate processing
        statusArea.style.display = 'block';
        statusMessage.textContent = `Starting ${writeMode === 'overwrite_all' ? 'overwrite' : 'expand/merge'}...`;
        progressBar.classList.add('progress-bar-animated');
        progressBar.classList.remove('bg-success', 'bg-danger');
        progressBar.style.width = '5%';
        progressBar.textContent = '5%';

        try {
            // Prepare request body
            const requestBody = {
                date_mode: dateMode,
                write_mode: writeMode,
                funds: selectedFunds
            };
            if (dateMode === 'range') {
                requestBody.start_date = startDate;
                requestBody.custom_end_date = customEndDate;
            } else {
                requestBody.days_back = parseInt(daysBack, 10);
                requestBody.end_date = endDate;
            }

            const response = await fetch('{{ url_for("api_bp.run_api_calls") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            const result = await response.json();
            progressBar.classList.remove('progress-bar-animated');

            if (response.ok && (result.status === 'completed' || result.status === 'completed_with_errors')) {
                statusMessage.textContent = result.message;
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                progressBar.classList.add(result.status === 'completed_with_errors' ? 'bg-warning' : 'bg-success');

                // Populate results table (add Last Written column)
                resultsTableBody.innerHTML = '';
                if (result.summary && result.summary.length > 0) {
                    result.summary.forEach(item => {
                        let rowsCellContent = 'N/A';
                        let linesCellContent = 'N/A';
                        if (item.actual_rows !== undefined && item.actual_rows !== null) {
                            rowsCellContent = item.actual_rows;
                            linesCellContent = item.actual_lines !== undefined ? item.actual_lines : (rowsCellContent > 0 ? rowsCellContent + 1 : 0);
                        } else if (item.simulated_rows !== undefined && item.simulated_rows !== null) {
                            rowsCellContent = item.simulated_rows;
                            linesCellContent = item.simulated_lines !== undefined ? item.simulated_lines : (rowsCellContent > 0 ? rowsCellContent + 1 : 0);
                        }
                        let fundCodeForRerun = item.fund_code || null;
                        if (!fundCodeForRerun && item.query_id && typeof item.query_id === 'string') {
                            const match = item.query_id.match(/some_pattern_to_extract_fund_code/);
                            if (match && match[1]) {
                                fundCodeForRerun = match[1];
                            }
                        }
                        const rerunButtonHtml = fundCodeForRerun
                            ? `<button class="btn btn-sm btn-outline-primary rerun-button" data-fund-code="${fundCodeForRerun}">Rerun</button>`
                            : `<span class="text-muted">Rerun N/A</span>`;
                        const row = `<tr data-query-id="${item.query_id}">
                                        <td>${item.query_id}</td>
                                        <td>${item.file_name}</td>
                                        <td>${rowsCellContent}</td>
                                        <td>${linesCellContent}</td>
                                        <td>${item.last_written ? item.last_written : 'N/A'}</td>
                                        <td><span class="badge ${item.status.includes('OK') || item.status.includes('Saved') ? 'bg-success' : (item.status.includes('Warning') ? 'bg-warning' : 'bg-danger')}">${item.status}</span></td>
                                        <td>${rerunButtonHtml}</td>
                                     </tr>`;
                        resultsTableBody.innerHTML += row;
                    });
                } else {
                    resultsTableBody.innerHTML = '<tr><td colspan="7">No summary data returned.</td></tr>';
                }
                errorMessageDiv.style.display = 'none';
                cleanupButton.style.display = 'inline-block';
            } else {
                statusMessage.textContent = 'Processing failed.';
                progressBar.style.width = '100%';
                progressBar.textContent = 'Error';
                progressBar.classList.add('bg-danger');
                errorMessageDiv.textContent = `Error: ${result.message || 'Unknown error'}`;
                errorMessageDiv.style.display = 'block';
            }
        } catch (error) {
            console.error("Fetch error:", error);
            progressBar.classList.remove('progress-bar-animated');
            progressBar.style.width = '100%';
            progressBar.textContent = 'Error';
            progressBar.classList.add('bg-danger');
            statusMessage.textContent = 'An error occurred during the request.';
            errorMessageDiv.textContent = 'Network error or server unreachable. Check console for details.';
            errorMessageDiv.style.display = 'block';
        }
    }
    // --- End of API call handler function ---

    // --- Event Listener for the original "Run API Calls" button (which is type="submit") ---
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        handleApiCall(false);
    });
    runOverwriteButton.addEventListener('click', function() {
        handleApiCall(true);
    });

    // Add event listener for the Rerun buttons using event delegation
    resultsTableBody.addEventListener('click', async function(event) {
        if (event.target.classList.contains('rerun-button')) {
            const button = event.target;
            const row = button.closest('tr');
            const queryId = row.dataset.queryId;
            const fundCode = button.dataset.fundCode;
            const daysBack = document.getElementById('daysBack').value;
            const endDate = document.getElementById('endDate').value;
            const cells = row.cells; // Define cells here so it's available in all blocks

            if (!fundCode || !queryId) {
                console.error('Missing fund code or query ID for rerun');
                // Optionally display an error to the user near the button/row
                return;
            }

            // Provide visual feedback
            button.disabled = true;
            button.textContent = 'Running...';
            // You could also add a temporary status cell or highlight the row

            try {
                const response = await fetch('/rerun-api-call', { // New endpoint needed
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query_id: queryId,
                        // Send fundCode as a list in the 'funds' key
                        funds: [fundCode],
                        days_back: parseInt(daysBack, 10),
                        end_date: endDate
                    })
                });

                const result = await response.json();

                // Use actual_rows/actual_lines as default, fallback to simulated if not present
                if (response.ok && result.status && result.status.includes('OK')) {
                    cells[2].textContent = result.actual_rows !== undefined ? result.actual_rows : (result.simulated_rows !== undefined ? result.simulated_rows : 'N/A');
                    cells[3].textContent = result.actual_lines !== undefined ? result.actual_lines : (result.simulated_lines !== undefined ? result.simulated_lines : 'N/A');
                    cells[4].innerHTML = `<span class="badge bg-success">${result.status}</span>`;
                    button.textContent = 'Rerun Success';
                    setTimeout(() => { button.textContent = 'Rerun'; }, 2000);
                } else {
                    cells[4].innerHTML = `<span class="badge bg-danger">Error</span>`;
                    console.error("Rerun failed:", result.message || 'Unknown error');
                    button.textContent = 'Rerun Failed';
                    setTimeout(() => { button.textContent = 'Rerun'; }, 3000);
                }

            } catch (error) {
                console.error("Rerun fetch error:", error);
                cells[4].innerHTML = `<span class="badge bg-danger">Network Error</span>`;
                button.textContent = 'Rerun Error';
                setTimeout(() => { button.textContent = 'Rerun'; }, 3000);
            } finally {
                button.disabled = false;
            }
        }
    });

    // Add event listener for the new Cleanup button
    cleanupButton.addEventListener('click', async function() {
        cleanupStatus.textContent = 'Starting cleanup process...';
        cleanupStatus.className = 'mt-2 alert alert-info';
        cleanupButton.disabled = true;

        try {
            const response = await fetch('/run-cleanup', {
                method: 'POST',
                 headers: {
                    'Content-Type': 'application/json',
                },
            });

            const result = await response.json();

            if (response.ok && result.status === 'success') {
                cleanupStatus.textContent = `Cleanup process finished successfully. Output:\n${result.output}`;
                cleanupStatus.className = 'mt-2 alert alert-success';
            } else {
                 cleanupStatus.textContent = `Cleanup process failed. Error:\n${result.error || result.message || 'Unknown error'}`;
                 cleanupStatus.className = 'mt-2 alert alert-danger';
            }

        } catch (error) {
            console.error("Cleanup fetch error:", error);
            cleanupStatus.textContent = 'Failed to trigger cleanup process. Network error or server unreachable.';
            cleanupStatus.className = 'mt-2 alert alert-danger';
        } finally {
             cleanupButton.disabled = false;
        }
    });
});
</script>
{% endblock %} 