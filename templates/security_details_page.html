{% extends 'base.html' %}

{% block title %}Security Details: {{ security_id }} - {{ metric_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>{{ security_id }} - {{ metric_name }}</h1>
    <p>Latest data as of: <strong>{{ latest_date }}</strong></p>
    
    {# Display Static Info #}
    {% if static_info %}
    <div class="mb-3 p-3 border rounded bg-light small">
        <strong>Static Details:</strong> 
        {% for key, value in static_info.items() %}
            <span class="me-3">{{ key }}: {{ value }}</span>
        {% endfor %}
    </div>
    {% endif %}

    {# Primary Chart Area (Metric + Price Overlay) #}
    <h2>{{ metric_name }} and Price Time Series</h2>
    <div id="primary-chart-container" class="mb-4" style="height: 450px; position: relative;">
        <canvas id="primarySecurityChart"></canvas>
    </div>

    {# Duration Chart Area #}
    <h2>Duration Time Series</h2>
    <div id="duration-chart-container" class="mb-4" style="height: 450px; position: relative;">
        <canvas id="durationSecurityChart"></canvas>
    </div>

    {# Hidden script tag for chart data #}
    <script id="chartJsonData" type="application/json">
        {{ chart_data_json|safe }}
    </script>

</div>
{% endblock %}

{% block scripts %}
{# Include Chart.js library (Likely inherited from base.html, but included here for safety/explicitness if needed) #}
{# If base.html already includes it, this line can be removed #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get the chart data passed from Flask
        const chartDataElement = document.getElementById('chartJsonData');
        const chartData = JSON.parse(chartDataElement.textContent);

        // --- Helper function to replace 0 with null in a dataset's data array ---
        const processDatasetData = (dataset) => {
            if (dataset && dataset.data) {
                dataset.data = dataset.data.map(value => (value === 0 ? null : value));
            }
            return dataset; // Return the processed dataset (or original if no data)
        };

        // --- Process datasets before creating charts ---
        if (chartData.primary_datasets) {
            chartData.primary_datasets = chartData.primary_datasets.map(processDatasetData);
        }
        if (chartData.duration_dataset) {
            chartData.duration_dataset = processDatasetData(chartData.duration_dataset);
        }


        // --- Render Primary Chart (Metric + Price) ---
        const primaryCtx = document.getElementById('primarySecurityChart').getContext('2d');
        if (chartData.primary_datasets && chartData.primary_datasets.length > 0) {
            // Check if *any* primary dataset has actual data after processing
            const hasPrimaryData = chartData.primary_datasets.some(dataset => 
                dataset.data && dataset.data.some(value => value !== null)
            );

            if (hasPrimaryData) {
                new Chart(primaryCtx, {
                    type: 'line',
                    data: {
                        labels: chartData.labels,
                        datasets: chartData.primary_datasets // Use the processed primary datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        spanGaps: true, // Ensure gaps are spanned correctly visually if desired, or set to false for explicit gaps
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            },
                            y: { // Primary Y-axis (for the main metric)
                                position: 'left',
                                title: {
                                    display: true,
                                    text: {{ metric_name|tojson }} + ' Value' // Use the metric name dynamically with tojson filter
                                }
                            },
                            y1: { // Secondary Y-axis (for Price)
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Price'
                                },
                                grid: {
                                    drawOnChartArea: false, // only draw grid lines for the first Y axis
                                },
                                // Optional: Define behaviour for nulls if needed, though spanGaps usually handles line drawing
                                // ticks: {
                                //     callback: function(value, index, values) {
                                //         // You could customize tick display here if needed
                                //         return value; 
                                //     }
                                // }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                            }
                        }
                    }
                });
            } else {
                console.log('No non-null data points found for any primary dataset.');
                document.getElementById('primary-chart-container').innerHTML = '<p class="text-info">No data available for the primary chart metrics over the selected period.</p>';
            }
        } else {
            console.error('No primary datasets found for the primary chart.');
            document.getElementById('primary-chart-container').innerHTML = '<p class="text-danger">Could not render primary chart: No data available.</p>';
        }

        // --- Render Duration Chart ---
        const durationCtx = document.getElementById('durationSecurityChart').getContext('2d');
        if (chartData.duration_dataset) {
             // Check if there's actual data in the *processed* duration dataset
            const hasDurationData = chartData.duration_dataset.data && chartData.duration_dataset.data.some(value => value !== null);

            if (hasDurationData) {
                new Chart(durationCtx, {
                    type: 'line',
                    data: {
                        labels: chartData.labels,
                        datasets: [chartData.duration_dataset] // Use the processed duration dataset
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        spanGaps: true, // Ensure gaps are spanned correctly visually if desired, or set to false for explicit gaps
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            },
                            y: { // Single Y-axis for duration
                                title: {
                                    display: true,
                                    text: 'Duration Value'
                                }
                            }
                            // Optional: Define behaviour for nulls if needed
                            // ticks: {
                            //     callback: function(value, index, values) {
                            //         return value; 
                            //     }
                            // }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                            }
                        }
                    }
                });
            } else {
                 console.log('No non-null data points found for the duration chart.');
                 document.getElementById('duration-chart-container').innerHTML = '<p class="text-info">No duration data available for this security over the selected period.</p>';
            }
        } else {
            console.log('Duration dataset not provided or empty.');
            document.getElementById('duration-chart-container').innerHTML = '<p class="text-info">Duration data not available for this security.</p>';
        }
    });
</script>
{% endblock %} 