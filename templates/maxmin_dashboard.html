{#
    Purpose: Dashboard for Max/Min Value Breach feature. Shows summary of max/min breaches for configured files.
    Can display all files or filter by group.
    Allows temporary threshold overrides.
#}
{% extends 'base.html' %}

{% block title %}{{ dashboard_title or 'Max/Min Value Breach Dashboard' }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>{{ dashboard_title or 'Max/Min Value Breach Dashboard' }}</h1>
    <p>Overview of securities breaching configured maximum or minimum value thresholds.</p>
    
    {# Determine form action URL based on whether a group is active #}
    {% set form_action_url = url_for('maxmin_bp.dashboard', group_name=group_name) if group_name else url_for('maxmin_bp.dashboard') %}

    {# --- Threshold Override Form --- #}
    <form method="GET" action="{{ form_action_url }}" class="row gx-2 gy-2 align-items-center mb-4 p-3 border rounded bg-light" id="dashboard-filter-form">
        <div class="col-auto">
            <label for="maxInput" class="form-label mb-0">Max:</label>
        </div>
        <div class="col-auto">
            {# Show config default as placeholder if no override, and value if override #}
            <input type="number" step="any" class="form-control form-control-sm" id="maxInput" name="max" value="{{ applied_max if applied_max is not none else '' }}" placeholder="{{ DEFAULT_MAX_THRESHOLD if applied_max is none else '' }}" style="width: 140px;" onchange="this.form.submit()" onkeydown="if(event.key==='Enter'){this.form.submit();}">
        </div>
        <div class="col-auto">
            <label for="minInput" class="form-label mb-0">Min:</label>
        </div>
        <div class="col-auto">
            {# Show config default as placeholder if no override, and value if override #}
            <input type="number" step="any" class="form-control form-control-sm" id="minInput" name="min" value="{{ applied_min if applied_min is not none else '' }}" placeholder="{{ DEFAULT_MIN_THRESHOLD if applied_min is none else '' }}" style="width: 140px;" onchange="this.form.submit()" onkeydown="if(event.key==='Enter'){this.form.submit();}">
        </div>
        <div class="col-auto">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="includeDistressed" name="include_distressed" value="1" {% if include_distressed %}checked{% endif %} onchange="this.form.submit()">
                <label class="form-check-label" for="includeDistressed">Include Distressed</label>
            </div>
        </div>
    </form>
    
    {% if applied_max is not none or applied_min is not none %}
        <div class="alert alert-info small" role="alert">
            Currently viewing with temporary overrides applied:
            {% if applied_max is not none %} Max = {{ applied_max }} {% endif %}
            {% if applied_min is not none %} Min = {{ applied_min }} {% endif %}
            (Configured defaults are shown per card below).
        </div>
    {% endif %}

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for item in summary_data %}
        <div class="col">
            {# Card border color based on breach status #}
            <div class="card h-100 {% if item.has_error %}border-danger{% elif item.max_breach_count > 0 or item.min_breach_count > 0 %}border-warning{% else %}border-success{% endif %}">
                <div class="card-body">
                    {# Display filename and the configured display name #}
                    <h5 class="card-title">{{ item.display_name }}</h5>
                    <p class="card-subtitle mb-2 text-muted small">({{ item.filename }})</p>
                    
                    {% if item.has_error %}
                        <p class="card-text text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Error processing this file.</p>
                        {# Optionally add details about the error if available #}
                    {% else %}
                        <p class="card-text small mb-1">
                            Total Securities: {{ item.total_count }}
                        </p>
                        <p class="card-text small mb-1 {% if item.max_breach_count > 0 %}text-danger fw-bold{% endif %}">
                            Max Breaches: {{ item.max_breach_count }}
                        </p>
                        <p class="card-text small {% if item.min_breach_count > 0 %}text-warning fw-bold{% endif %}">
                            Min Breaches: {{ item.min_breach_count }}
                        </p>
                        {# Display the actual thresholds used for this item (config default or override) #}
                        <p class="card-text text-muted fst-italic" style="font-size: 0.75rem;">
                            Thresholds Used: Max={{ item.max_threshold }}, Min={{ item.min_threshold }}
                        </p>
                        <div class="mt-auto pt-2">
                            <a href="{{ item.max_details_url }}" class="btn btn-outline-danger btn-sm me-1 {% if item.max_breach_count == 0 %}disabled{% endif %}" title="View Max Breach Details">
                                <i class="fas fa-arrow-up me-1"></i>Max
                            </a>
                            <a href="{{ item.min_details_url }}" class="btn btn-outline-warning btn-sm {% if item.min_breach_count == 0 %}disabled{% endif %}" title="View Min Breach Details">
                                <i class="fas fa-arrow-down me-1"></i>Min
                            </a>
                        </div>
                    {% endif %}
                </div>
                {# Footer indicating status #}
                <div class="card-footer text-center {% if item.has_error %}bg-danger-subtle text-danger-emphasis{% elif item.max_breach_count > 0 or item.min_breach_count > 0 %}bg-warning-subtle text-warning-emphasis{% else %}bg-success-subtle text-success-emphasis{% endif %}">
                    <small>
                        {% if item.has_error %}
                            Processing Error
                        {% elif item.max_breach_count > 0 or item.min_breach_count > 0 %}
                            Breaches Found
                        {% else %}
                            No Breaches Found
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12">
            <p class="text-info">No files configured for this Max/Min group{% if not group_name %} (or overall){% endif %}.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %} 