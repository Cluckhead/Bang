{% extends 'base.html' %}
{% block title %}KRD vs Duration Comparison{% endblock %}

{% block content %}
{% set template_key = 'krd_vs_duration' %}
{% include "_help_link.html" %}
<div class="p-4"> {# match other views #}
  <h2 class="text-2xl font-bold font-heading mb-1">KRD vs Duration (Tol {{ tolerance }})</h2>
  <p class="text-gray-600 text-sm mb-4">Absolute difference greater than tolerance is highlighted.</p>

  {# --- Top controls (date + toggle) in a card --- #}
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4 max-w-xl flex flex-wrap items-center space-x-4">
      <form method="get" id="dateForm" class="flex items-center space-x-2">
          <input type="hidden" name="sp" value="{{ '1' if sp else '0' }}">
          <label for="tolInp" class="text-sm mr-1">Tol:</label>
          <input type="number" name="tol" id="tolInp" step="0.01" min="0" value="{{ tolerance }}" class="border border-gray-300 rounded px-2 py-1 text-sm w-20" onchange="document.getElementById('dateForm').submit()">
          <label for="dateSel" class="text-sm font-medium text-gray-700">Date:</label>
          <select name="date" id="dateSel" class="mt-1 block w-36 pl-2 pr-8 py-1 text-sm border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-secondary focus:border-secondary" onchange="this.form.submit()">
            {% for d in dates %}
              <option value="{{ d }}" {% if d == selected_date %}selected{% endif %}>{{ d }}</option>
            {% endfor %}
          </select>
      </form>

      {# S&P toggle #}
      <form method="get" id="spForm" class="flex items-center space-x-2">
          <input type="hidden" name="date" value="{{ selected_date }}">
          <input type="hidden" name="tol" value="{{ tolerance }}">
          <label for="spToggle" class="text-sm font-medium text-gray-700">S&amp;P</label>
          <input type="checkbox" id="spToggle" name="sp" value="1" class="h-4 w-4 text-primary border-gray-300 rounded" {% if sp %}checked{% endif %} onchange="document.getElementById('spForm').submit()">
      </form>
  </div>

  {# --- Data table card --- #}
  <div class="bg-[#F7F7F7] rounded-lg shadow-[0_0_4px_rgba(0,0,0,0.06)] hover:shadow-md transition-shadow overflow-hidden">
      <div class="overflow-x-auto">
          <table id="krd-duration-table" class="min-w-full divide-y divide-gray-200 text-sm">
              <thead class="bg-gray-50">
                  <tr>
                      <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase cursor-pointer sortable" data-column-name="ISIN">ISIN</th>
                      <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase cursor-pointer sortable" data-column-name="Security Name">Name</th>
                      <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase cursor-pointer sortable" data-column-name="Date">Date</th>
                      <th class="px-4 py-2 text-right text-xs font-semibold text-gray-600 uppercase cursor-pointer sortable" data-column-name="bucket_sum">KRD&nbsp;Sum</th>
                      <th class="px-4 py-2 text-right text-xs font-semibold text-gray-600 uppercase cursor-pointer sortable" data-column-name="duration">Duration</th>
                      <th class="px-4 py-2 text-right text-xs font-semibold text-gray-600 uppercase cursor-pointer sortable" data-column-name="abs_diff">Diff</th>
                      <th class="px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase">Chart</th>
                  </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                {% for row in rows %}
                  <tr class="hover:bg-gray-50 {% if row.breach %}bg-red-50{% endif %}">
                      <td class="px-4 py-2 whitespace-nowrap">
                        <a href="{{ url_for('security.security_details', metric_name='Duration', security_id=row['ISIN']) }}" class="text-primary hover:underline">
                          {{ row['ISIN'] }}
                        </a>
                      </td>
                      <td class="px-4 py-2 whitespace-nowrap">{{ row.get('Security Name', '') }}</td>
                      <td class="px-4 py-2 whitespace-nowrap">{{ row.Date }}</td>
                      <td class="px-4 py-2 whitespace-nowrap text-right" data-value="{{ row.bucket_sum }}">{{ '%.2f'|format(row.bucket_sum) }}</td>
                      <td class="px-4 py-2 whitespace-nowrap text-right" data-value="{{ row.duration }}">{{ '%.2f'|format(row.duration) }}</td>
                      <td class="px-4 py-2 whitespace-nowrap text-right font-medium {% if row.breach %}text-red-600{% else %}text-gray-800{% endif %}" data-value="{{ row.abs_diff }}">{{ '%.2f'|format(row.abs_diff) }}</td>
                      <td class="px-4 py-2 whitespace-nowrap text-center">
                        <a href="{{ url_for('krd_bp.krd_historical_chart', isin=row['ISIN'], sp='1' if sp else '0') }}" 
                           class="inline-flex items-center px-2 py-1 text-xs font-medium text-primary bg-primary-50 rounded-md hover:bg-primary-100 transition-colors"
                           title="View historical KRD vs Duration chart for {{ row['ISIN'] }}">
                          <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 00-2-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 00-2 2h2a2 2 0 00-2-2z"></path>
                          </svg>
                          Chart
                        </a>
                      </td>
                  </tr>
                {% else %}
                  <tr><td colspan="7" class="text-center py-4 text-gray-500 italic">No data for selected date.</td></tr>
                {% endfor %}
              </tbody>
          </table>
      </div>
  </div>
</div>
{% endblock %} 