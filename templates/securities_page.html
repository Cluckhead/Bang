{% extends 'base.html' %}

{% block title %}Security Data Check{% endblock %}

{% block head_extra %}
  {# Link the new CSS file #}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Security Data Check</h2>
        {# Add button to navigate to the exclusions page #}
        <a href="{{ url_for('exclusion_bp.manage_exclusions') }}" class="btn btn-outline-secondary btn-sm">Manage Exclusions</a>
    </div>
    <p>Potential data issues based on the latest daily change Z-score for each security and metric.</p>
    
    {% if message %}
    <div class="alert alert-warning" role="alert">
        {{ message }}
    </div>
    {% endif %}

    {# Search Form #}
    <form method="GET" action="{{ url_for('security.securities_page') }}" class="mb-3">
        <div class="input-group">
            <input type="text" name="search_term" class="form-control" placeholder="Search by Security Name..." value="{{ search_term or '' }}">
            <button class="btn btn-outline-secondary" type="submit">Search</button>
            {# Optional: Add a clear button #}
            {% if search_term %}
                <a href="{{ url_for('security.securities_page') }}" class="btn btn-outline-danger">Clear</a>
            {% endif %}
        </div>
    </form>

    {# Filter Section - Basic implementation without JS interactivity for now #}
    {% if filter_options %}
    <div class="mb-3 p-3 border rounded bg-light">
        <h5>Filters</h5>
        <div class="row">
            {% for column, options in filter_options.items() %}
            <div class="col-md-3 mb-2">
                <label for="filter-{{ column|replace(' ', '_') }}" class="form-label">{{ column }}</label>
                <select id="filter-{{ column|replace(' ', '_') }}" class="form-select form-select-sm security-filter-select" data-column="{{ column }}"> 
                    <option value="">All</option>
                    {% for option in options %}
                    <option value="{{ option }}">{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {# Data Table Section #}
    {% if securities_data %}
    <div class="table-responsive">
        <table class="table table-striped table-hover table-sm small" id="securities-table">
            <thead class="table-light">
                <tr>
                    {# Add sortable class and data-column attribute to each header #}
                    {% for col_name in column_order %}
                        <th class="sortable" data-column-name="{{ col_name }}">
                            {{ col_name }} <span class="sort-indicator"></span> {# Placeholder for sort arrow #}
                        </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody id="securities-table-body">
                {% for row in securities_data %}
                    {% set z_score = row['Change Z-Score'] %}
                    {% set abs_z_score = z_score|abs if z_score is not none else 0 %}
                    {% set row_class = 'table-danger' if abs_z_score >= 3 else ('table-warning' if abs_z_score >= 2 else '') %}
                    <tr class="{{ row_class }}">
                        {% for col_name in column_order %}
                            {# Add data-value attribute for easier sorting, especially for formatted numbers #}
                            <td data-value="{{ row[col_name] if row[col_name] is not none else '' }}">
                                {# Check if this is the ID column #}
                                {% if col_name == id_col_name %}
                                    {# Construct the link - Requires a new route #}
                                    {# Since this page only shows Spread data now, hardcode metric_name #}
                                    <a href="{{ url_for('security.security_details_page', metric_name='Spread', security_id=row[col_name]|urlencode) }}">
                                        {{ row[col_name] }}
                                    </a>
                                {% elif col_name == 'Change Z-Score' and row[col_name] is not none %}
                                    {{ "%.2f"|format(row[col_name]) }}
                                {% elif row[col_name] is number %}
                                    {{ "%.3f"|format(row[col_name]) }}
                                {% else %}
                                    {{ row[col_name] if row[col_name] is not none else '' }}
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% elif not message %}
     <div class="alert alert-info" role="alert">
        No security metrics data to display.
    </div>
    {% endif %}
</div>

{% endblock %} 